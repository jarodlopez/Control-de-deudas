<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Finanzas</title>
    
    <!-- Estilos Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React y ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase Compat -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .print-only { display: block !important; }
        }
        /* Animación suave para el modal */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 300ms, transform 300ms; }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- ICONOS ---
        const Icon = ({ path, className, size = 24, onClick }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} onClick={onClick}>
                {path}
            </svg>
        );

        const Icons = {
            ArrowLeft: (p) => <Icon {...p} path={<><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></>} />,
            Plus: (p) => <Icon {...p} path={<><path d="M5 12h14"/><path d="M12 5v14"/></>} />,
            Trash2: (p) => <Icon {...p} path={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>} />,
            Camera: (p) => <Icon {...p} path={<><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></>} />,
            Clock: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} />,
            CheckCircle: (p) => <Icon {...p} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />,
            AlertCircle: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></>} />,
            LogOut: (p) => <Icon {...p} path={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>} />,
            Printer: (p) => <Icon {...p} path={<><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></>} />,
            Mail: (p) => <Icon {...p} path={<><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></>} />,
            Lock: (p) => <Icon {...p} path={<><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>} />,
            UserPlus: (p) => <Icon {...p} path={<><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" x2="20" y1="8" y2="14"/><line x1="23" x2="17" y1="11" y2="11"/></>} />,
            LogIn: (p) => <Icon {...p} path={<><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></>} />,
            Settings: (p) => <Icon {...p} path={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>} />,
            TrendingUp: (p) => <Icon {...p} path={<><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></>} />,
            Eye: (p) => <Icon {...p} path={<><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></>} />,
            X: (p) => <Icon {...p} path={<><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>} />,
            FileText: (p) => <Icon {...p} path={<><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></>} />
        };

        const Loader2 = ({ className }) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
        );

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAqSpQNq1zswQwv9kS61xF9YfOrBr4ZEvI",
            authDomain: "pagosnic.firebaseapp.com",
            databaseURL: "https://pagosnic-default-rtdb.firebaseio.com",
            projectId: "pagosnic",
            storageBucket: "pagosnic.firebasestorage.app",
            messagingSenderId: "670554138038",
            appId: "1:670554138038:web:f30247b8294f0b15750d17"
        };
        const IMGBB_API_KEY = "b922654effe3a1ab5ac85cc4c23f97b8";

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // --- LOGICA FECHAS ---
        const formatMoney = (amount) => new Intl.NumberFormat('es-NI', { style: 'currency', currency: 'NIO', minimumFractionDigits: 2 }).format(amount);

        const formatDate = (dateString) => {
            if (!dateString) return '';
            const date = new Date(dateString);
            const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            const offsetDate = new Date(date.getTime() + userTimezoneOffset);
            return offsetDate.toLocaleDateString('es-NI', { year: 'numeric', month: 'short', day: 'numeric' });
        };

        // Generador inteligente de cuotas
        const generateInstallments = (total, count, startDate, frequency, customDays = 0, fixedDays = []) => {
            const amountPerInstallment = total / count;
            const installments = [];
            let currentDate = new Date(startDate);
            // Ajuste zona horaria
            const userTimezoneOffset = currentDate.getTimezoneOffset() * 60000;
            currentDate = new Date(currentDate.getTime() + userTimezoneOffset);

            // Si es por fechas fijas (ej. 15 y 30)
            if (frequency === 'fixed_biweekly' && fixedDays.length === 2) {
                let generatedCount = 0;
                // Empezamos iterando desde el mes de la fecha de inicio
                let loopDate = new Date(currentDate);
                
                // Máximo 5 años para evitar bucles infinitos por error
                while (generatedCount < count) {
                    const year = loopDate.getFullYear();
                    const month = loopDate.getMonth();
                    
                    // Ordenar días fijos (ej. 15 antes de 30)
                    const days = [...fixedDays].sort((a,b) => a-b);

                    for (let d of days) {
                        if (generatedCount >= count) break;

                        // Ajustar días para meses cortos (ej. día 30 en febrero)
                        const maxDaysInMonth = new Date(year, month + 1, 0).getDate();
                        const safeDay = Math.min(d, maxDaysInMonth);
                        
                        const candidateDate = new Date(year, month, safeDay);

                        // Solo agregar si la fecha es igual o posterior a la fecha de inicio
                        // (Reseteamos horas para comparar solo fechas)
                        const cDateStr = candidateDate.toISOString().split('T')[0];
                        const sDateStr = currentDate.toISOString().split('T')[0];

                        if (cDateStr >= sDateStr) {
                            installments.push({
                                id: generatedCount + 1,
                                dueDate: cDateStr,
                                amount: amountPerInstallment
                            });
                            generatedCount++;
                        }
                    }
                    // Avanzar al siguiente mes
                    loopDate.setMonth(loopDate.getMonth() + 1);
                    loopDate.setDate(1); // Resetear al día 1 del siguiente mes
                }
            } else {
                // Lógica estándar (semanal, mensual, etc.)
                for (let i = 0; i < count; i++) {
                    installments.push({
                        id: i + 1,
                        dueDate: currentDate.toISOString().split('T')[0],
                        amount: amountPerInstallment
                    });
                    
                    if (frequency === 'weekly') currentDate.setDate(currentDate.getDate() + 7);
                    else if (frequency === 'biweekly') currentDate.setDate(currentDate.getDate() + 14);
                    else if (frequency === 'semimonthly') currentDate.setDate(currentDate.getDate() + 15);
                    else if (frequency === 'monthly') currentDate.setMonth(currentDate.getMonth() + 1);
                    else if (frequency === 'custom' && customDays > 0) currentDate.setDate(currentDate.getDate() + parseInt(customDays));
                }
            }
            return installments;
        };

        // --- COMPONENTE APP ---
        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('login'); 
            const [debts, setDebts] = useState([]);
            const [selectedDebtId, setSelectedDebtId] = useState(null);
            
            // UI States
            const [loading, setLoading] = useState(false);
            const [uploading, setUploading] = useState(false);
            const [viewPayment, setViewPayment] = useState(null); // Para el modal de detalle

            // Auth Forms
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isRegistering, setIsRegistering] = useState(false);
            const [authError, setAuthError] = useState('');

            // Data Forms
            const [formData, setFormData] = useState({ 
                title: '', amount: '', type: 'simple', 
                startDate: new Date().toISOString().split('T')[0], 
                installmentsCount: 2, 
                frequency: 'monthly',
                customFrequencyDays: '',
                fixedDay1: 15,
                fixedDay2: 30
            });
            
            const [payData, setPayData] = useState({ amount: '', date: new Date().toISOString().split('T')[0], receipt: '', file: null });

            // --- EFFECTS ---
            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((u) => {
                    setUser(u);
                    if (u) {
                        setView('list');
                        setEmail(''); setPassword(''); setAuthError('');
                    } else {
                        setView('login');
                    }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (user) {
                    const debtsRef = db.ref(`users/${user.uid}/debts`);
                    debtsRef.on('value', (snap) => {
                        const data = snap.val();
                        const loaded = [];
                        if (data) {
                            Object.keys(data).forEach(key => {
                                const d = data[key];
                                loaded.push({
                                    id: key,
                                    ...d,
                                    payments: d.payments ? Object.values(d.payments) : [],
                                    charges: d.extraCharges ? Object.values(d.extraCharges) : []
                                });
                            });
                        }
                        setDebts(loaded.reverse());
                    });
                    return () => debtsRef.off();
                }
            }, [user]);

            // --- ACTIONS ---
            const handleAuth = async (e) => {
                e.preventDefault();
                setLoading(true); setAuthError('');
                try {
                    if (isRegistering) await auth.createUserWithEmailAndPassword(email, password);
                    else await auth.signInWithEmailAndPassword(email, password);
                } catch (error) {
                    setAuthError(error.message);
                }
                setLoading(false);
            };

            const uploadToImgBB = async (file) => {
                const d = new FormData(); d.append("image", file);
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: d });
                const j = await res.json();
                return j.success ? j.data.url : null;
            };

            const createDebt = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    const total = parseFloat(formData.amount);
                    let installments = [];
                    
                    if (formData.type === 'installments') {
                        installments = generateInstallments(
                            total, 
                            parseInt(formData.installmentsCount), 
                            formData.startDate, 
                            formData.frequency,
                            formData.customFrequencyDays,
                            [parseInt(formData.fixedDay1), parseInt(formData.fixedDay2)]
                        );
                    } else {
                        installments = [{ id: 1, dueDate: formData.startDate, amount: total }];
                    }

                    await db.ref(`users/${user.uid}/debts`).push({
                        title: formData.title,
                        initialAmount: total,
                        type: formData.type,
                        installments: installments, 
                        createdAt: new Date().toISOString()
                    });
                    setFormData({ 
                        title: '', amount: '', type: 'simple', 
                        startDate: new Date().toISOString().split('T')[0], 
                        installmentsCount: 2, 
                        frequency: 'monthly',
                        customFrequencyDays: '',
                        fixedDay1: 15, fixedDay2: 30
                    });
                    setView('list');
                } catch (err) { alert(err.message); }
                setLoading(false);
            };

            const addPayment = async (e) => {
                e.preventDefault();
                if (!payData.amount) return;
                setUploading(true);
                try {
                    let url = payData.file ? await uploadToImgBB(payData.file) : "";
                    await db.ref(`users/${user.uid}/debts/${selectedDebtId}/payments`).push({
                        amount: parseFloat(payData.amount),
                        date: payData.date,
                        receiptNumber: payData.receipt || 'S/N',
                        imageUrl: url,
                        timestamp: new Date().toISOString()
                    });
                    setPayData({ ...payData, amount: '', receipt: '', file: null });
                } catch (err) { alert(err.message); }
                setUploading(false);
            };

            const getDebtAnalysis = (debt) => {
                const initial = parseFloat(debt.initialAmount);
                const paidTotal = (debt.payments || []).reduce((s, p) => s + (parseFloat(p.amount)||0), 0);
                const remaining = initial - paidTotal;
                
                let paidAccumulator = paidTotal;
                let nextDue = null;
                
                const installmentsStatus = (debt.installments || []).map(inst => {
                    const amount = parseFloat(inst.amount);
                    let status = 'pending';
                    let paidForThis = 0;

                    if (paidAccumulator >= amount) {
                        status = 'paid'; paidForThis = amount; paidAccumulator -= amount;
                    } else if (paidAccumulator > 0) {
                        status = 'partial'; paidForThis = paidAccumulator; paidAccumulator = 0;
                    } else {
                        status = 'pending'; paidForThis = 0;
                    }
                    const isOverdue = status !== 'paid' && new Date(inst.dueDate) < new Date();
                    if (!nextDue && status !== 'paid') nextDue = { date: inst.dueDate, amount: amount - paidForThis, isOverdue };
                    return { ...inst, status, paidForThis, isOverdue };
                });
                return { totalDebt: initial, paidTotal, remaining, installmentsStatus, nextDue };
            };

            // --- VISTAS ---

            if (view === 'login') return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-gray-100 p-6">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm">
                        <div className="text-center mb-6">
                            <div className="bg-blue-100 p-3 rounded-full inline-block mb-2"><Icons.TrendingUp className="text-blue-600" size={32} /></div>
                            <h1 className="text-2xl font-bold text-gray-800">Mis Finanzas</h1>
                            <p className="text-gray-500 text-sm">Gestiona tus deudas personales</p>
                        </div>
                        <form onSubmit={handleAuth} className="space-y-4">
                            <div className="relative">
                                <div className="absolute left-3 top-3 text-gray-400"><Icons.Mail size={18} /></div>
                                <input type="email" required className="w-full pl-10 p-3 border rounded-lg bg-gray-50 outline-none" placeholder="Correo" value={email} onChange={e => setEmail(e.target.value)} />
                            </div>
                            <div className="relative">
                                <div className="absolute left-3 top-3 text-gray-400"><Icons.Lock size={18} /></div>
                                <input type="password" required className="w-full pl-10 p-3 border rounded-lg bg-gray-50 outline-none" placeholder="Contraseña" value={password} onChange={e => setPassword(e.target.value)} />
                            </div>
                            {authError && <div className="bg-red-50 text-red-600 text-xs p-3 rounded-lg flex items-center">{authError}</div>}
                            <button disabled={loading} className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold">
                                {loading ? <Loader2 className="animate-spin mx-auto" /> : (isRegistering ? 'Crear Cuenta' : 'Iniciar Sesión')}
                            </button>
                        </form>
                        <div className="mt-6 text-center border-t pt-4">
                            <button onClick={() => { setIsRegistering(!isRegistering); setAuthError(''); }} className="text-blue-600 font-bold text-sm">
                                {isRegistering ? "Iniciar Sesión" : "Crear cuenta nueva"}
                            </button>
                        </div>
                    </div>
                </div>
            );

            if (view === 'create') return (
                <div className="min-h-screen bg-gray-50 p-4 max-w-md mx-auto">
                    <header className="flex items-center mb-6">
                        <button onClick={() => setView('list')} className="mr-4 text-gray-600"><Icons.ArrowLeft /></button>
                        <h1 className="font-bold text-xl text-gray-800">Nueva Deuda</h1>
                    </header>
                    <form onSubmit={createDebt} className="bg-white p-6 rounded-xl shadow-sm space-y-4">
                        <input required type="text" className="w-full p-3 border rounded-lg bg-gray-50" value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} placeholder="Acreedor / Concepto" />
                        <div className="relative">
                            <span className="absolute left-3 top-3 text-gray-500 font-bold">C$</span>
                            <input required type="number" className="w-full pl-10 p-3 border rounded-lg bg-gray-50" value={formData.amount} onChange={e => setFormData({...formData, amount: e.target.value})} placeholder="Monto Total" />
                        </div>
                        <div className="flex bg-gray-100 p-1 rounded-lg">
                            <button type="button" onClick={() => setFormData({...formData, type: 'simple'})} className={`flex-1 py-2 rounded-md text-sm font-medium ${formData.type === 'simple' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>Un solo pago</button>
                            <button type="button" onClick={() => setFormData({...formData, type: 'installments'})} className={`flex-1 py-2 rounded-md text-sm font-medium ${formData.type === 'installments' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>A Plazos</button>
                        </div>
                        {formData.type === 'installments' && (
                            <div className="space-y-4 bg-blue-50 p-4 rounded-lg border border-blue-100 animate-in fade-in">
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="text-xs text-blue-700 font-bold">Inicio Pagos</label>
                                        <input type="date" className="w-full p-2 border rounded text-sm" value={formData.startDate} onChange={e => setFormData({...formData, startDate: e.target.value})} />
                                    </div>
                                    <div>
                                        <label className="text-xs text-blue-700 font-bold">Cuotas</label>
                                        <input type="number" min="2" className="w-full p-2 border rounded text-sm" value={formData.installmentsCount} onChange={e => setFormData({...formData, installmentsCount: e.target.value})} />
                                    </div>
                                </div>
                                <div>
                                    <label className="text-xs text-blue-700 font-bold">Frecuencia</label>
                                    <select className="w-full p-2 border rounded text-sm bg-white" value={formData.frequency} onChange={e => setFormData({...formData, frequency: e.target.value})}>
                                        <option value="weekly">Semanal (Cada 7 días)</option>
                                        <option value="biweekly">Catorcenal (Cada 14 días)</option>
                                        <option value="semimonthly">Quincenal (Cada 15 días)</option>
                                        <option value="monthly">Mensual (Cada mes)</option>
                                        <option value="fixed_biweekly">Quincenal (Fechas Exactas)</option>
                                        <option value="custom">Otro (Días Personalizados)</option>
                                    </select>
                                </div>
                                {/* Días Fijos */}
                                {formData.frequency === 'fixed_biweekly' && (
                                    <div className="grid grid-cols-2 gap-3 animate-in fade-in">
                                        <div>
                                            <label className="text-xs text-blue-700 font-bold">Día de pago 1</label>
                                            <input type="number" min="1" max="31" className="w-full p-2 border rounded text-sm" value={formData.fixedDay1} onChange={e => setFormData({...formData, fixedDay1: e.target.value})} placeholder="Ej. 15" />
                                        </div>
                                        <div>
                                            <label className="text-xs text-blue-700 font-bold">Día de pago 2</label>
                                            <input type="number" min="1" max="31" className="w-full p-2 border rounded text-sm" value={formData.fixedDay2} onChange={e => setFormData({...formData, fixedDay2: e.target.value})} placeholder="Ej. 30" />
                                        </div>
                                    </div>
                                )}
                                {formData.frequency === 'custom' && (
                                    <div>
                                        <label className="text-xs text-blue-700 font-bold">Cada cuántos días</label>
                                        <input type="number" className="w-full p-2 border rounded text-sm" value={formData.customFrequencyDays} onChange={e => setFormData({...formData, customFrequencyDays: e.target.value})} placeholder="Ej. 3" />
                                    </div>
                                )}
                            </div>
                        )}
                        <button disabled={loading} className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700">{loading ? <Loader2 className="animate-spin mx-auto"/> : 'Guardar'}</button>
                    </form>
                </div>
            );

            if (view === 'detail') {
                const debt = debts.find(d => d.id === selectedDebtId);
                if(!debt) return null;
                const { remaining, totalDebt, paidTotal, installmentsStatus } = getDebtAnalysis(debt);
                const progress = Math.min(100, (paidTotal / totalDebt) * 100);

                return (
                    <div className="min-h-screen bg-gray-50 font-sans max-w-md mx-auto relative">
                        {/* HEADER */}
                        <header className="bg-white p-4 shadow-sm flex justify-between sticky top-0 z-10 no-print">
                            <div className="flex items-center gap-2">
                                <button onClick={() => setView('list')}><Icons.ArrowLeft /></button>
                                <h1 className="font-bold text-lg truncate w-48 text-gray-800">{debt.title}</h1>
                            </div>
                            <button onClick={() => window.print()} className="bg-gray-100 p-2 rounded-full"><Icons.Printer size={20}/></button>
                        </header>

                        <div className="p-4 space-y-6 pb-20">
                            {/* TARJETA SALDO */}
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 text-center">
                                <p className="text-xs uppercase text-gray-400 font-bold tracking-wider">Deuda Restante</p>
                                <p className={`text-4xl font-extrabold my-2 ${remaining <= 0 ? 'text-green-500' : 'text-gray-800'}`}>{formatMoney(remaining)}</p>
                                <div className="w-full bg-gray-100 rounded-full h-3 mb-4 overflow-hidden no-print">
                                    <div className="bg-blue-600 h-full transition-all duration-500" style={{width: `${progress}%`}}></div>
                                </div>
                                <div className="flex justify-between text-sm">
                                    <div className="text-left"><span className="block text-gray-400 text-xs">Total</span><span className="font-bold">{formatMoney(totalDebt)}</span></div>
                                    <div className="text-right"><span className="block text-gray-400 text-xs">Pagado</span><span className="font-bold text-green-600">{formatMoney(paidTotal)}</span></div>
                                </div>
                            </div>

                            {/* FORMULARIO PAGO (MEJORADO) */}
                            <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 no-print">
                                <h3 className="font-bold text-blue-800 text-sm mb-3 flex items-center"><span className="mr-2"><Icons.Plus size={16} /></span> Registrar Abono</h3>
                                <div className="space-y-3">
                                    <div className="flex gap-2">
                                        <div className="relative flex-1">
                                            <span className="absolute left-2 top-2 text-blue-300 font-bold">C$</span>
                                            <input type="number" step="0.01" className="w-full pl-8 p-2 rounded border border-blue-200 text-sm focus:outline-blue-500" placeholder="Monto" value={payData.amount} onChange={e => setPayData({...payData, amount: e.target.value})} />
                                        </div>
                                        <input type="date" className="w-32 p-2 rounded border border-blue-200 text-xs" value={payData.date} onChange={e => setPayData({...payData, date: e.target.value})} />
                                    </div>
                                    
                                    <div className="flex gap-2 items-center">
                                        <div className="flex-1 relative">
                                            <div className="absolute left-2 top-2 text-blue-300"><Icons.FileText size={16}/></div>
                                            <input type="text" className="w-full pl-8 p-2 rounded border border-blue-200 text-sm focus:outline-blue-500" placeholder="Nº Documento / Recibo" value={payData.receipt} onChange={e => setPayData({...payData, receipt: e.target.value})} />
                                        </div>
                                        <label className={`p-2 bg-white rounded border border-blue-200 cursor-pointer ${payData.file ? 'text-green-500 border-green-500' : 'text-gray-400'}`}>
                                            <Icons.Camera size={20} />
                                            <input type="file" className="hidden" onChange={e => setPayData({...payData, file: e.target.files[0]})} />
                                        </label>
                                    </div>

                                    <button onClick={addPayment} disabled={uploading} className="w-full bg-blue-600 text-white p-2 rounded font-bold text-sm shadow-sm hover:bg-blue-700 transition">
                                        {uploading ? <Loader2 className="animate-spin mx-auto" size={16} /> : 'Confirmar Pago'}
                                    </button>
                                </div>
                            </div>

                            {/* LISTA DE CUOTAS */}
                            {debt.type === 'installments' && (
                                <div>
                                    <h3 className="font-bold text-gray-800 mb-3 flex items-center"><span className="mr-2"><Icons.Clock size={16} /></span> Plan de Pagos</h3>
                                    <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                                        {installmentsStatus.map((inst, idx) => (
                                            <div key={idx} className={`flex justify-between items-center p-3 border-b last:border-0 ${inst.status === 'paid' ? 'bg-green-50' : ''}`}>
                                                <div className="flex items-center gap-3">
                                                    {inst.status === 'paid' ? <span className="text-green-500"><Icons.CheckCircle size={18} /></span> : inst.isOverdue ? <span className="text-red-500"><Icons.AlertCircle size={18} /></span> : <div className="w-4 h-4 rounded-full border-2 border-gray-300"></div>}
                                                    <div>
                                                        <p className={`text-sm font-bold ${inst.status === 'paid' ? 'text-green-800' : inst.isOverdue ? 'text-red-600' : 'text-gray-600'}`}>Cuota #{inst.id}</p>
                                                        <p className="text-xs text-gray-400">{formatDate(inst.dueDate)}</p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <p className="text-sm font-bold">{formatMoney(inst.amount)}</p>
                                                    {inst.status === 'partial' && <p className="text-[10px] text-orange-500 font-bold">Resta: {formatMoney(inst.amount - inst.paidForThis)}</p>}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* HISTORIAL */}
                            <div>
                                <h3 className="font-bold text-gray-800 mb-3">Historial</h3>
                                <div className="space-y-2">
                                    {(debt.payments || []).slice().reverse().map((pay, i) => (
                                        <div key={i} className="flex justify-between items-center bg-white p-3 rounded-lg border border-gray-100 text-sm">
                                            <div>
                                                <p className="font-bold text-gray-800">{formatMoney(pay.amount)}</p>
                                                <p className="text-xs text-gray-500">{formatDate(pay.date)} {pay.receiptNumber && `• Doc: ${pay.receiptNumber}`}</p>
                                            </div>
                                            <button onClick={() => setViewPayment(pay)} className="text-blue-500 p-2 hover:bg-blue-50 rounded-full transition"><Icons.Eye size={18}/></button>
                                        </div>
                                    ))}
                                    {(debt.payments || []).length === 0 && <p className="text-gray-400 text-sm italic text-center py-4">Sin movimientos</p>}
                                </div>
                            </div>
                        </div>

                        {/* MODAL DETALLE PAGO */}
                        {viewPayment && (
                            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 modal-enter-active">
                                <div className="bg-white rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl">
                                    <div className="p-4 border-b flex justify-between items-center">
                                        <h3 className="font-bold text-gray-800">Detalle del Pago</h3>
                                        <button onClick={() => setViewPayment(null)} className="text-gray-500"><Icons.X /></button>
                                    </div>
                                    <div className="p-6 text-center space-y-4">
                                        <div>
                                            <p className="text-sm text-gray-500">Monto Pagado</p>
                                            <p className="text-3xl font-bold text-gray-800">{formatMoney(viewPayment.amount)}</p>
                                        </div>
                                        <div className="grid grid-cols-2 gap-4 text-sm bg-gray-50 p-3 rounded-lg">
                                            <div><p className="text-gray-400 text-xs">Fecha</p><p className="font-semibold">{formatDate(viewPayment.date)}</p></div>
                                            <div><p className="text-gray-400 text-xs">Recibo Nº</p><p className="font-semibold">{viewPayment.receiptNumber || '---'}</p></div>
                                        </div>
                                        {viewPayment.imageUrl ? (
                                            <div className="rounded-lg overflow-hidden border">
                                                <img src={viewPayment.imageUrl} alt="Comprobante" className="w-full h-48 object-cover" />
                                                <a href={viewPayment.imageUrl} target="_blank" className="block bg-gray-100 p-2 text-xs text-blue-600 hover:underline">Ver imagen completa</a>
                                            </div>
                                        ) : (
                                            <div className="h-32 flex items-center justify-center bg-gray-100 rounded-lg text-gray-400 text-sm italic">Sin comprobante adjunto</div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            if (view === 'list') return (
                <div className="min-h-screen bg-gray-100 font-sans max-w-md mx-auto">
                    <header className="bg-white p-4 flex justify-between items-center shadow-sm sticky top-0 z-10">
                        <div>
                            <h1 className="font-bold text-xl text-gray-800">Mis Finanzas</h1>
                            <p className="text-xs text-gray-500 truncate max-w-[150px]">{user.email}</p>
                        </div>
                        <button onClick={() => auth.signOut()} className="text-gray-500 hover:text-red-500 transition"><Icons.LogOut size={20} /></button>
                    </header>
                    <div className="p-4 space-y-6">
                        <div className="bg-slate-800 rounded-2xl p-6 text-white shadow-lg">
                            <p className="text-slate-400 text-xs uppercase font-bold">Deuda Total Activa</p>
                            <h2 className="text-4xl font-bold mt-1">{formatMoney(debts.reduce((s, d) => s + getDebtAnalysis(d).remaining, 0))}</h2>
                        </div>
                        <button onClick={() => setView('create')} className="w-full bg-blue-600 text-white p-4 rounded-xl font-bold shadow-lg hover:bg-blue-700 flex justify-center items-center gap-2 transition active:scale-95">
                            <Icons.Plus /> Nueva Deuda
                        </button>
                        <div className="space-y-4 pb-10">
                            {debts.map(debt => {
                                const { remaining, totalDebt, paidTotal, nextDue } = getDebtAnalysis(debt);
                                const progress = (paidTotal / totalDebt) * 100;
                                return (
                                    <div key={debt.id} onClick={() => { setSelectedDebtId(debt.id); setView('detail'); }} className="bg-white p-4 rounded-xl shadow-sm border border-gray-200 cursor-pointer hover:shadow-md transition">
                                        <div className="flex justify-between items-start mb-2">
                                            <h3 className="font-bold text-gray-800 text-lg">{debt.title}</h3>
                                            {remaining <= 0 ? <span className="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full font-bold">PAGADO</span> : <span className="bg-blue-50 text-blue-700 text-xs px-2 py-1 rounded-full font-bold">ACTIVO</span>}
                                        </div>
                                        <div className="w-full bg-gray-100 rounded-full h-2 mb-3"><div className={`h-full rounded-full ${remaining <= 0 ? 'bg-green-500' : 'bg-blue-600'}`} style={{width: `${progress}%`}}></div></div>
                                        {remaining > 0 && nextDue && (
                                            <div className={`mt-3 p-2 rounded-lg text-xs flex items-center justify-between ${nextDue.isOverdue ? 'bg-red-50 text-red-700 border border-red-100' : 'bg-gray-50 text-gray-600'}`}>
                                                <div className="flex items-center gap-2"><Icons.Clock size={14} /><span>Próximo pago: <b>{formatDate(nextDue.date)}</b></span></div>
                                                <span className="font-bold">{formatMoney(nextDue.amount)}</span>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>



